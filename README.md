# Starfish-Spectral-Fitting
Repository for final project - ASTR 6410

For this project, I have developed a single python script capabale of fitting a stellar spectrum to one of many different models using the Starfish spectral inference software. This software was chosen due to its partial implementation of Gaussian process regression to downweight systematic oulier spectral features with a spectrum when determining the best-fit and in the PCA portion of the spectral emulator. 

This project consists of the program titled "Starfish_Model_Fitting.py" and the spectrum being fit titled "example_spec.hdf5." This program is very similar (nearly identical) to the example given on the "readthedocs" page for Starfish showing how to fit a single-order stellar spectrum (https://starfish.readthedocs.io/en/latest/overview.html). To recreate this work, one must install the astrostarfish package to their machine: details can be found at the site previously mentioned.

The program begins by using Starfish.grid_tools.download_PHOENIX_models to download PHOENIX stellar spectrum models in a specified range of parameters for effective temperature (Teff), log of the surface gravity (logg), and metallicity (Z). The model spectra are then combined into and "HDF5" data structure to make the grid exploration more efficient than reading FITS files over and over. This is accomplished with Starfish.grid_tools.PHOENIXGridInterfaceNoAlpha and Starfish.grid_tools.HDF5Creator. Additionally, the HDF5Creator will truncate the wavelength range and resample each spectrum to the resolution and wavelength range of the instrument being used by passing the instrument found in Starfish.grid_tools.instruments to the HDF5Creator. In this example, I used the SPEX instrument.

The next step is to set up the spectral emulator (Starfish.emulator.Emulator), which uses a comination of principal component analysis and Gaussian process regression to decompose the model spectra in our grid into eigenspectra with weights given as functions of model parameters described by gaussian processes. This emulator is key to transforming the finite parameter space of our model grid to a continuous space. This way, Starfish can utilize standard optimization algorithms such as MCMC. After the emulator is setup, it is "trained," which is when the eigenspectra and weights are determined. Once the emulator is trained, it is saved as and "HDF5" file.

Then, the program uses Starfish.spectrum.Spectrum's "load()" method to load the example spectrum's data. Additionally, you can use the constructor of this class to create your own Starfish compatible Spectrum object (which is what I did when attempting to fit an additional spectrum). This object is how the Starfish sowftware access the data from your spectrum. Once this object has been created it is passed as an argument to Starfish.models.SpectrumModel's constructor along with the saved emulator's file name and initial guesses for model parameters. This SpectrumModel object is then "trained," which means a maximum-liklihood estimate is performed for the given data using scipy.optimize.minimize. This training makes use of a dictionary of priors for each model parameter which as passed as and argument (i.e. SpectrumModel.train(priors)). In the example I have implemented, the "logg" model parameter was "frozen" or fixed before training the model. The most likely model is then saved to be used as the starting point for MCMC analysis.

Next, the program moves on to the MCMC optimization, which is accomplished via emcee. This begins by defining length scales associated with each model parameter to initializze a Gaussian ball as a starting point for 50 walkers. A function titled log_prob is then constructed to be used to return the log liklihood of a model with the data given by the SpectrumModel object, which is passed to the emcee.EnsemblSampler. Once the EnsembleSample is constructed, I conduct MCMC on the model parameters with a max number of iterations of 1000, while checking to see when the model has converged. After convergence is reached, 100 additional samples are taken to ensure clean chains and the burn-in data is removed. Finally, the most likely parameters and uncertainties from the MCMC optimization are used to define the best-fit model.

Attempts have been made to fit a spectrum other than the example provided by Starfish using PHEONIX models. However, I have not been able to get past an error that arrises when performing the maximum-likelihood estimate to determine initial model parameters to be used in the MCMC portion of the algorithm. The spectral emulator is set up using a combination of Gaussian process regression and principal component analysis to interpolate between model parameters in the specified grid. However, when I perform the maximum-liklihood estimate by "training" my model, the the algorithm keeps exploring parameter values outside of my established model grid resulting in the following error: "ValueError: Querying emulator outside of original parameter range." I have yet to resolve this issue. 
The data I have attempted to fit came from Park et al. 2018 and is an H-band spectrum of HD108477 taken with IGRINS. I created an additional class in the Starfish "instruments.py" file for the exact specifications of the instrument and spectrum I was using. (I will attach this file as well, and it must replace the orignal file in your system to run the modified version of the program I am attaching) I have tried restricting my priors to ranges far below my grid parameter ranges and even attempted to make my grid very large (which took a lot of download time) with no luck. I even attempted to use other spectra from Rayner et al. (ApJS, 185, 289) collected with the SPEX instrument as well, but I ran into identical issues. The PHOENIX models did not seem to reproduce any of the spectra or their features very well, which leads me to believe I may have better luck with a different set of model spectra (i.e not PHOENIX models). However, I have run out of time for this project. I have also included the additional spectra I attempted to fit: "HD108477_H_IGRINS_spectrum.txt," HD218804_SpeX_spectrum.txt," and "HD27524_SpeX_spectrum.txt." The modified code for one of these fits can be found as well: "Starfish_fitting_hd108477.py." This will reproduce the error I was encountering. For this reason, all code after line  may not be modified yet.
